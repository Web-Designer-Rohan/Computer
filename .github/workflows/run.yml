name: ðŸš€ OpenWebUI Auto-Install + Tunnels
on: 
  workflow_dispatch:

jobs:
  openwebui:
    runs-on: ubuntu-latest
    container: kalilinux/kali-rolling:latest
    timeout-minutes: 360
    
    steps:
    - name: ðŸ”§ System Setup
      run: |
        apt-get update && apt-get install -y \
          curl wget openssh-server sudo git procps htop docker.io
        
        # Fix Docker (no systemd)
        dockerd-entrypoint.sh & 
        sleep 10
        
        # SSH Setup
        ssh-keygen -A
        sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        useradd -m -s /bin/bash kaliuser || true
        echo 'kaliuser:kali2026' | chpasswd
        echo 'kaliuser ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/kaliuser
        chmod 0440 /etc/sudoers.d/kaliuser
        service ssh start
        
    - name: ðŸ³ Docker Compose OpenWebUI
      run: |
        cd /home
        mkdir -p kaliuser/openwebui/{data,config,ollama}
        
        cat > kaliuser/openwebui/docker-compose.yml << 'EOF'
        version: '3.8'
        services:
          openwebui:
            image: ghcr.io/open-webui/open-webui:main
            container_name: openwebui
            volumes:
              - ./data:/app/backend/data
              - ./config:/app/config
            ports:
              - "3000:8080"
            environment:
              - WEBUI_SECRET_KEY=kali2026
            restart: unless-stopped
            
          ollama:
            image: ollama/ollama:latest
            container_name: ollama
            volumes:
              - ./ollama:/root/.ollama
            ports:
              - "11434:11434"
            restart: unless-stopped
        EOF
        
        chown -R 1000:1000 kaliuser/openwebui
        cd kaliuser/openwebui
        docker-compose up -d
        
        echo "â³ Waiting for OpenWebUI..."
        for i in {1..12}; do curl -f http://localhost:3000 && break || sleep 10; done
        echo "âœ… OpenWebUI LIVE: http://localhost:3000"
        echo "ðŸ“± Login: admin@admin.com / admin"
        
    - name: ðŸŒ Dual Tunnels (SSH + OpenWebUI)
      run: |
        curl -Ls https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-unknown-linux-musl.tar.gz | tar zx
        
        echo "ðŸš€ LIVE CONNECTIONS:"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # SSH Tunnel
        echo "ðŸ“¡ SSH:"
        ./bore local 22 --to bore.pub &
        SSH_PORT=$(lsof -i -P -n | grep LISTEN | grep bore | head -1 | awk '{print $9}' | cut -d: -f2)
        echo "ssh kaliuser@bore.pub -p $SSH_PORT"
        
        # OpenWebUI Tunnel  
        echo "ðŸŒ OpenWebUI:"
        ./bore local 3000 --to bore.pub &
        WEBUI_PORT=$(lsof -i -P -n | grep LISTEN | grep bore | tail -1 | awk '{print $9}' | cut -d: -f2)
        echo "http://bore.pub:$WEBUI_PORT"
        
        echo ""
        echo "ðŸ‘¤ kaliuser : kali2026"
        echo "â° Active 6 hours"
        echo ""
        
        # Health monitor
        while true; do
          docker ps | grep openwebui && service ssh status && echo "$(date): ALL SYSTEMS GO âœ…"
          sleep 60
        done &
        
        sleep 6h
